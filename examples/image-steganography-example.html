<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图像隐写术示例 - Text Blind Watermark JS</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="file"], input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .stats {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🖼️ 图像隐写术示例</h1>
        
        <div class="info">
            <strong>功能说明：</strong>使用LSB（最低有效位）隐写术技术，将文本信息隐藏在图像的像素中。
            支持加密、数据完整性校验等高级功能。
        </div>

        <!-- 隐藏数据部分 -->
        <div class="section">
            <h2>📝 隐藏数据到图像</h2>
            
            <div class="form-group">
                <label for="sourceImage">选择源图像：</label>
                <input type="file" id="sourceImage" accept="image/*">
            </div>
            
            <div class="form-group">
                <label for="messageToHide">要隐藏的文本：</label>
                <textarea id="messageToHide" placeholder="输入要隐藏的文本信息..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="hidePassword">加密密码（可选）：</label>
                <input type="password" id="hidePassword" placeholder="输入密码以加密隐藏的数据">
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="enableChecksum" checked>
                <label for="enableChecksum">启用数据完整性校验</label>
            </div>
            
            <button onclick="hideMessage()">隐藏数据</button>
            <button onclick="downloadHiddenImage()" id="downloadBtn" disabled>下载隐藏图像</button>
            
            <div id="hideResult"></div>
            <div id="imageStats"></div>
            <canvas id="hiddenCanvas" style="display: none;"></canvas>
        </div>

        <!-- 提取数据部分 -->
        <div class="section">
            <h2>🔍 从图像中提取数据</h2>
            
            <div class="form-group">
                <label for="hiddenImage">选择包含隐藏数据的图像：</label>
                <input type="file" id="hiddenImage" accept="image/*">
            </div>
            
            <div class="form-group">
                <label for="extractPassword">解密密码（如果有）：</label>
                <input type="password" id="extractPassword" placeholder="输入解密密码">
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="extractChecksum" checked>
                <label for="extractChecksum">验证数据完整性</label>
            </div>
            
            <button onclick="extractMessage()">提取数据</button>
            <button onclick="checkHiddenData()">检查是否包含隐藏数据</button>
            
            <div id="extractResult"></div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="extractedMessage">提取的文本：</label>
                <textarea id="extractedMessage" readonly></textarea>
            </div>
        </div>
    </div>

    <!-- 引入crypto-js依赖 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- 引入图像隐写术模块 -->
    <script src="../dist/image-steganography.umd.js"></script>
    <script>
        const { ImageSteganography, CanvasImageProcessor } = window.ImageSteganography;
        
        let hiddenImageData = null;
        let steganography = null;

        // 全局函数
        window.hideMessage = async function() {
            try {
                const fileInput = document.getElementById('sourceImage');
                const message = document.getElementById('messageToHide').value;
                const password = document.getElementById('hidePassword').value;
                const enableChecksum = document.getElementById('enableChecksum').checked;
                
                if (!fileInput.files[0]) {
                    showResult('hideResult', '请选择源图像文件', 'error');
                    return;
                }
                
                if (!message.trim()) {
                    showResult('hideResult', '请输入要隐藏的文本', 'error');
                    return;
                }
                
                showResult('hideResult', '正在处理图像...', 'info');
                
                // 创建隐写术实例
                steganography = new ImageSteganography({
                    password: password || undefined,
                    checksum: enableChecksum
                });
                
                // 加载图像
                const imageData = await CanvasImageProcessor.loadImageFromFile(fileInput.files[0]);
                
                // 显示图像统计信息
                const maxCapacity = steganography.getMaxCapacity(imageData);
                const messageSize = new TextEncoder().encode(message).length;
                
                document.getElementById('imageStats').innerHTML = `
                    <div class="stats">
                        <strong>图像信息：</strong><br>
                        尺寸: ${imageData.width} × ${imageData.height}<br>
                        最大容量: ${maxCapacity} 字节<br>
                        消息大小: ${messageSize} 字节<br>
                        容量使用率: ${(messageSize / maxCapacity * 100).toFixed(2)}%
                    </div>
                `;
                
                // 隐藏数据
                hiddenImageData = steganography.hideData(imageData, message);
                
                // 显示结果
                showResult('hideResult', '数据隐藏成功！', 'success');
                document.getElementById('downloadBtn').disabled = false;
                
            } catch (error) {
                showResult('hideResult', `错误: ${error.message}`, 'error');
                console.error(error);
            }
        };

        window.downloadHiddenImage = function() {
            if (hiddenImageData) {
                CanvasImageProcessor.downloadImage(hiddenImageData, 'hidden-image.png');
            }
        };

        window.extractMessage = async function() {
            try {
                const fileInput = document.getElementById('hiddenImage');
                const password = document.getElementById('extractPassword').value;
                const enableChecksum = document.getElementById('extractChecksum').checked;
                
                if (!fileInput.files[0]) {
                    showResult('extractResult', '请选择包含隐藏数据的图像文件', 'error');
                    return;
                }
                
                showResult('extractResult', '正在提取数据...', 'info');
                
                // 创建隐写术实例
                const extractSteganography = new ImageSteganography({
                    password: password || undefined,
                    checksum: enableChecksum
                });
                
                // 加载图像
                const imageData = await CanvasImageProcessor.loadImageFromFile(fileInput.files[0]);
                
                // 提取数据
                const extractedMessage = extractSteganography.extractData(imageData);
                
                // 显示结果
                document.getElementById('extractedMessage').value = extractedMessage;
                showResult('extractResult', '数据提取成功！', 'success');
                
            } catch (error) {
                showResult('extractResult', `错误: ${error.message}`, 'error');
                document.getElementById('extractedMessage').value = '';
                console.error(error);
            }
        };

        window.checkHiddenData = async function() {
            try {
                const fileInput = document.getElementById('hiddenImage');
                
                if (!fileInput.files[0]) {
                    showResult('extractResult', '请选择图像文件', 'error');
                    return;
                }
                
                // 创建隐写术实例
                const checkSteganography = new ImageSteganography();
                
                // 加载图像
                const imageData = await CanvasImageProcessor.loadImageFromFile(fileInput.files[0]);
                
                // 检查是否包含隐藏数据
                const hasHidden = checkSteganography.hasHiddenData(imageData);
                
                if (hasHidden) {
                    showResult('extractResult', '✅ 图像包含隐藏数据', 'success');
                } else {
                    showResult('extractResult', '❌ 图像不包含隐藏数据', 'info');
                }
                
            } catch (error) {
                showResult('extractResult', `错误: ${error.message}`, 'error');
                console.error(error);
            }
        };

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // 文件选择预览
        document.getElementById('sourceImage').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('img');
                    preview.src = e.target.result;
                    preview.className = 'image-preview';
                    
                    const existing = document.querySelector('#sourceImage + .image-preview');
                    if (existing) existing.remove();
                    
                    e.target.parentNode.insertBefore(preview, e.target.nextSibling);
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById('hiddenImage').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('img');
                    preview.src = e.target.result;
                    preview.className = 'image-preview';
                    
                    const existing = document.querySelector('#hiddenImage + .image-preview');
                    if (existing) existing.remove();
                    
                    e.target.parentNode.insertBefore(preview, e.target.nextSibling);
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
    </script>
</body>
</html>